<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guia Interativo: Adicionando Comandos de Voz ao Bot Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Tech (Slate, Blue, Teal) -->
    <!-- Application Structure Plan: An interactive, single-page tutorial structured as a vertical stepper/accordion. Each major part (GCP, Apps Script, Code, Deploy) is a collapsible section to guide the user sequentially and reduce cognitive load. This task-oriented structure is more user-friendly for a technical guide than a simple long-form document. Key interactions include code-copying buttons and checklists to track progress. -->
    <!-- Visualization & Content Choices: The tutorial content is broken into actionable steps. Goal: Guide user. Presentation: Structured HTML with Tailwind, using <details> for collapsible sections. Interaction: Click-to-expand sections and click-to-copy code snippets. Icons from Font Awesome are used to visually represent actions, improving clarity. No charts or complex visualizations are needed. CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details[open] summary .arrow-down {
            transform: rotate(180deg);
        }
        .step-number {
            background-color: #e0f2fe; /* sky-100 */
            color: #0c4a6e; /* sky-800 */
        }
        .code-block {
            background-color: #1e293b; /* slate-800 */
            color: #e2e8f0; /* slate-200 */
            border-radius: 0.5rem;
            padding: 1rem;
            position: relative;
        }
        .copy-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background-color: #475569; /* slate-600 */
            color: #cbd5e1; /* slate-300 */
            border: none;
            padding: 0.25rem 0.6rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }
        .copy-btn:hover {
            background-color: #64748b; /* slate-500 */
        }
        .copy-btn .fa-copy { display: inline-block; }
        .copy-btn .fa-check { display: none; }
        .copy-btn.copied .fa-copy { display: none; }
        .copy-btn.copied .fa-check { display: inline-block; }
        .task-item input:checked + label .fa-circle { display: none; }
        .task-item input:checked + label .fa-check-circle { display: inline-block; color: #22c55e; } /* green-500 */
        .task-item input:checked + label span { text-decoration: line-through; color: #64748b; } /* slate-500 */
    </style>
</head>
<body class="text-slate-700">
    <div class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        
        <header class="text-center mb-10">
            <i class="fa-solid fa-microphone-lines text-5xl text-sky-600 mb-4"></i>
            <h1 class="text-4xl font-bold text-slate-900">Adicionar Comandos de Voz ao seu Bot</h1>
            <p class="mt-2 text-lg text-slate-600">Um guia interativo para integrar a API de Speech-to-Text ao seu bot financeiro do Telegram.</p>
        </header>

        <main class="space-y-6">
            
            <!-- Parte 1: Google Cloud Platform -->
            <details class="bg-white border border-slate-200 rounded-lg shadow-sm" open>
                <summary class="p-5 cursor-pointer flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="step-number w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">1</div>
                        <div>
                            <h2 class="text-xl font-semibold text-slate-800">Configuração no Google Cloud (GCP)</h2>
                            <p class="text-slate-500 text-sm mt-1">Criação do projeto, ativação da API e geração da chave de segurança.</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-down arrow-down transition-transform"></i>
                </summary>
                <div class="p-6 border-t border-slate-200">
                    <div class="space-y-4">
                        <div class="task-item">
                            <input type="checkbox" id="task1-1" class="hidden">
                            <label for="task1-1" class="flex items-center space-x-3 cursor-pointer">
                                <i class="fa-regular fa-circle text-sky-600"></i>
                                <i class="fa-solid fa-check-circle hidden"></i>
                                <span>Criar um novo projeto no <a href="https://console.cloud.google.com/" target="_blank" class="text-sky-600 font-medium hover:underline">Google Cloud Console</a> e associar uma conta de faturamento.</span>
                            </label>
                        </div>
                        <div class="task-item">
                            <input type="checkbox" id="task1-2" class="hidden">
                            <label for="task1-2" class="flex items-center space-x-3 cursor-pointer">
                                <i class="fa-regular fa-circle text-sky-600"></i>
                                <i class="fa-solid fa-check-circle hidden"></i>
                                <span>Na Biblioteca de APIs, buscar e ativar a <strong>Cloud Speech-to-Text API</strong>.</span>
                            </label>
                        </div>
                        <div class="task-item">
                            <input type="checkbox" id="task1-3" class="hidden">
                            <label for="task1-3" class="flex items-center space-x-3 cursor-pointer">
                                <i class="fa-regular fa-circle text-sky-600"></i>
                                <i class="fa-solid fa-check-circle hidden"></i>
                                <span>Em "Credenciais", criar uma nova <strong>Chave de API</strong> e copiar o valor gerado.</span>
                            </label>
                        </div>
                        <div class="task-item">
                            <input type="checkbox" id="task1-4" class="hidden">
                            <label for="task1-4" class="flex items-center space-x-3 cursor-pointer">
                                <i class="fa-regular fa-circle text-sky-600"></i>
                                <i class="fa-solid fa-check-circle hidden"></i>
                                <span>Clicar na chave criada, selecionar <strong>Restringir chave</strong> e permitir apenas a "Cloud Speech-to-Text API".</span>
                            </label>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Parte 2: Google Apps Script Config -->
            <details class="bg-white border border-slate-200 rounded-lg shadow-sm">
                <summary class="p-5 cursor-pointer flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="step-number w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">2</div>
                        <div>
                            <h2 class="text-xl font-semibold text-slate-800">Configuração no Apps Script</h2>
                            <p class="text-slate-500 text-sm mt-1">Armazenando sua chave de API de forma segura no projeto.</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-down arrow-down transition-transform"></i>
                </summary>
                <div class="p-6 border-t border-slate-200">
                    <p class="mb-4">Vá para <i class="fa-solid fa-cog"></i> <strong>Configurações do Projeto</strong> > <strong>Propriedades de Script</strong> e adicione a seguinte propriedade:</p>
                    <div class="grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-md border">
                        <div>
                            <label class="font-semibold text-slate-800">Propriedade</label>
                            <div class="mt-1 p-2 bg-white rounded border border-slate-300 font-mono text-sm">SPEECH_API_KEY</div>
                        </div>
                        <div>
                            <label class="font-semibold text-slate-800">Valor</label>
                            <div class="mt-1 p-2 bg-white rounded border border-slate-300 font-mono text-sm text-slate-400">[Cole sua chave de API aqui]</div>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Parte 3: Implementação do Código -->
            <details class="bg-white border border-slate-200 rounded-lg shadow-sm">
                <summary class="p-5 cursor-pointer flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="step-number w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">3</div>
                        <div>
                            <h2 class="text-xl font-semibold text-slate-800">Implementação do Código</h2>
                            <p class="text-slate-500 text-sm mt-1">Adicionando os scripts para processar os áudios.</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-down arrow-down transition-transform"></i>
                </summary>
                <div class="p-6 border-t border-slate-200 space-y-6">
                    <div>
                        <h3 class="font-semibold text-lg text-slate-800 mb-2"><i class="fa-solid fa-plus-square text-teal-600 mr-2"></i>Crie o arquivo `SpeechToTextAPI.gs`</h3>
                        <p class="mb-3 text-slate-600">Este script se comunica com a API do Google para transcrever o áudio.</p>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyCode(this, 'code1')"><i class="fa-regular fa-copy"></i><i class="fa-solid fa-check"></i> Copiar</button>
                            <pre><code id="code1">/**
 * @file SpeechToTextAPI.gs
 * @description Encapsula a lógica de comunicação com a API de transcrição de áudio.
 */
function transcribeAudio(audioBlob) {
  const SPEECH_API_KEY = PropertiesService.getScriptProperties().getProperty('SPEECH_API_KEY');
  if (!SPEECH_API_KEY) {
    logToSheet("Chave da API Speech-to-Text não configurada.", "ERROR");
    return null;
  }
  const apiUrl = \`https://speech.googleapis.com/v1/speech:recognize?key=\${SPEECH_API_KEY}\`;
  const audioBytes = audioBlob.getBytes();
  const audioBase64 = Utilities.base64Encode(audioBytes);
  const payload = {
    config: {
      encoding: 'OGG_OPUS',
      sampleRateHertz: 48000,
      languageCode: 'pt-BR',
      enableAutomaticPunctuation: true,
      model: 'default'
    },
    audio: { content: audioBase64 }
  };
  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  const response = UrlFetchApp.fetch(apiUrl, options);
  const result = JSON.parse(response.getContentText());
  if (result.results && result.results[0].alternatives && result.results[0].alternatives.length > 0) {
    const transcript = result.results[0].alternatives[0].transcript;
    logToSheet(\`Texto transcrito: "\${transcript}"\`, "INFO");
    return transcript;
  } else {
    logToSheet(\`Falha na transcrição. Resposta da API: \${JSON.stringify(result)}\`, "WARN");
    return null;
  }
}</code></pre>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-semibold text-lg text-slate-800 mb-2"><i class="fa-solid fa-plus-square text-teal-600 mr-2"></i>Crie o arquivo `VoiceHandler.gs`</h3>
                        <p class="mb-3 text-slate-600">Este script gerencia o fluxo: recebe a voz, envia para transcrição e passa o texto para a lógica principal.</p>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyCode(this, 'code2')"><i class="fa-regular fa-copy"></i><i class="fa-solid fa-check"></i> Copiar</button>
                            <pre><code id="code2">/**
 * @file VoiceHandler.gs
 * @description Orquestra o processo de recebimento, download e transcrição de mensagens de voz.
 */
function handleVoiceMessage(message) {
  const chatId = message.chat.id;
  const fileId = message.voice.file_id;
  try {
    const audioBlob = getTelegramFile(fileId);
    if (!audioBlob) {
      enviarMensagemTelegram(chatId, "❌ Desculpe, não consegui baixar seu áudio.");
      return;
    }
    const transcribedText = transcribeAudio(audioBlob);
    if (!transcribedText) {
      enviarMensagemTelegram(chatId, "❌ Desculpe, não consegui entender o que você disse.");
      return;
    }
    const configData = getSheetDataWithCache(SHEET_CONFIGURACOES, CACHE_KEY_CONFIG);
    const usuario = getUsuarioPorChatId(chatId, configData);
    if (usuario === "Desconhecido") {
        enviarMensagemTelegram(chatId, "❌ Você não está autorizado a usar este bot.");
        return;
    }
    enviarMensagemTelegram(chatId, \`Entendi sua mensagem como: "_\${transcribedText}_"\n\nAnalisando...\`);
    interpretarMensagemTelegram(transcribedText, usuario, chatId);
  } catch (e) {
    logToSheet(\`Erro ao processar mensagem de voz: \${e.message}\`, "ERROR");
    enviarMensagemTelegram(chatId, "❌ Ocorreu um erro inesperado ao processar sua mensagem de voz.");
  }
}</code></pre>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold text-lg text-slate-800 mb-2"><i class="fa-solid fa-pencil text-amber-600 mr-2"></i>Modifique o arquivo `TelegramAPI.gs`</h3>
                        <p class="mb-3 text-slate-600">Adicione esta função ao final do arquivo para permitir o download de arquivos de áudio do Telegram.</p>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyCode(this, 'code3')"><i class="fa-regular fa-copy"></i><i class="fa-solid fa-check"></i> Copiar</button>
                            <pre><code id="code3">/**
 * Baixa um arquivo do Telegram usando o file_id.
 * @param {string} fileId O ID do arquivo a ser baixado.
 * @returns {Blob|null} O conteúdo do arquivo como um Blob, ou null em caso de falha.
 */
function getTelegramFile(fileId) {
  const token = getTelegramBotToken();
  const getFileUrl = \`\${URL_BASE_TELEGRAM}\${token}/getFile?file_id=\${fileId}\`;
  const fileInfoResponse = UrlFetchApp.fetch(getFileUrl, { muteHttpExceptions: true });
  const fileInfo = JSON.parse(fileInfoResponse.getContentText());
  if (!fileInfo.ok) {
    logToSheet(\`Erro ao obter informações do arquivo \${fileId}: \${fileInfo.description}\`, "ERROR");
    return null;
  }
  const filePath = fileInfo.result.file_path;
  const fileUrl = \`https://api.telegram.org/file/bot\${token}/\${filePath}\`;
  const fileResponse = UrlFetchApp.fetch(fileUrl, { muteHttpExceptions: true });
  if (fileResponse.getResponseCode() === 200) {
    return fileResponse.getBlob();
  }
  logToSheet(\`Falha ao baixar o arquivo de \${fileUrl}. Código: \${fileResponse.getResponseCode()}\`, "ERROR");
  return null;
}</code></pre>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-semibold text-lg text-slate-800 mb-2"><i class="fa-solid fa-pencil text-amber-600 mr-2"></i>Modifique o arquivo `Code.gs`</h3>
                        <p class="mb-3 text-slate-600">Adicione este bloco de código no início da sua função `doPost(e)` para interceptar as mensagens de voz.</p>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyCode(this, 'code4')"><i class="fa-regular fa-copy"></i><i class="fa-solid fa-check"></i> Copiar</button>
                            <pre><code id="code4">// Adicione este bloco dentro da sua função doPost(e),
// logo após a linha que define a variável 'data'.

if (data.message && data.message.voice) {
  logToSheet("Mensagem de voz recebida.", "INFO");
  handleVoiceMessage(data.message); // Chama o novo handler
  return; // Encerra a execução, pois a mensagem de voz já foi tratada.
}</code></pre>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Parte 4: Publicação e Teste -->
            <details class="bg-white border border-slate-200 rounded-lg shadow-sm">
                <summary class="p-5 cursor-pointer flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="step-number w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">4</div>
                        <div>
                            <h2 class="text-xl font-semibold text-slate-800">Publicação e Teste</h2>
                            <p class="text-slate-500 text-sm mt-1">Finalizando a implementação e verificando o resultado.</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-down arrow-down transition-transform"></i>
                </summary>
                <div class="p-6 border-t border-slate-200">
                    <div class="space-y-4">
                        <p><i class="fa-solid fa-rocket text-sky-600 mr-2"></i>Clique em <strong>Implantar > Nova implantação</strong> no editor do Apps Script para que suas alterações entrem em vigor.</p>
                        <p><i class="fa-solid fa-paper-plane text-sky-600 mr-2"></i>Abra seu bot no Telegram e envie uma mensagem de voz, como: <strong class="text-slate-800">"gastei 25 reais no café com o cartão do Itaú"</strong>.</p>
                        <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded-r-lg">
                            <div class="flex">
                                <div class="py-1"><i class="fa-solid fa-check-circle text-green-500 mr-3"></i></div>
                                <div>
                                    <p class="font-semibold text-green-800">Resultado Esperado</p>
                                    <p class="text-green-700">O bot deverá responder com o texto que ele entendeu e, em seguida, pedir a confirmação do lançamento, assim como faria com uma mensagem de texto.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </details>
        </main>

        <footer class="text-center mt-12 text-slate-400 text-sm">
            <p>Guia gerado para o projeto Gasto Certo. Boa sorte!</p>
        </footer>
    </div>

    <script>
        function copyCode(button, codeId) {
            const codeEl = document.getElementById(codeId);
            const text = codeEl.innerText;
            
            // Using a temporary textarea to copy
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            // Visual feedback
            button.classList.add('copied');
            button.querySelector('span').innerText = 'Copiado!';
            
            setTimeout(() => {
                button.classList.remove('copied');
                button.querySelector('span').innerText = '';
            }, 2000);
        }
    </script>
</body>
</html>
